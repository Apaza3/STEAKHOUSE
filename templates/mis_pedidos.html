{% extends 'base.html' %}
{% load static %}

{% block title %}Mis Pedidos{% endblock %}

{% block content %}
<div class="container my-5" style="min-height: 60vh;">
    
    <!-- ENCABEZADO CON LOGO -->
    <div class="text-center mb-5">
        <!-- Asegúrate de que la imagen exista en static/img/ -->
        <img src="{% static 'core/img/logo-steakhouse.png' %}" alt="The Steakhouse" class="mb-3" style="max-width: 150px; filter: drop-shadow(0 0 10px rgba(192, 154, 91, 0.3));">
        <h1 class="title-gold display-5" style="font-family: 'Playfair Display', serif;">Historial de Pedidos</h1>
        <p class="text-muted" style="font-family: 'Playfair Display', serif; letter-spacing: 1px; font-style: italic;">
            Consulta el estado de tus órdenes
        </p>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            {% if pedidos %}
                {% for pedido in pedidos %}
                <div class="card card-dark-theme mb-5 shadow-lg" style="border: 1px solid #c09a5b;">
                    
                    <!-- CABECERA DEL TICKET -->
                    <div class="card-header border-bottom border-secondary d-flex justify-content-between align-items-center py-3" 
                         style="background: linear-gradient(to right, rgba(192, 154, 91, 0.1), rgba(0,0,0,0));">
                        <div>
                            <span class="fw-bold title-gold fs-5" style="font-family: 'Playfair Display', serif;">Pedido #{{ pedido.id }}</span>
                            <div class="text-muted small font-monospace">
                                {{ pedido.fecha_pedido|date:"d/m/Y • H:i" }}
                            </div>
                        </div>
                        
                        <!-- BADGE DE ESTADO -->
                        <div>
                            {% if pedido.estado_pedido == 'PENDIENTE' %}
                                <span class="badge bg-warning text-dark border border-warning">En espera</span>
                            {% elif pedido.estado_pedido == 'EN_PREPARACION' %}
                                <span class="badge bg-info text-white border border-info">Cocinando <i class="fas fa-fire ms-1"></i></span>
                            {% elif pedido.estado_pedido == 'LISTO' %}
                                <span class="badge bg-primary border border-primary">¡Listo! <i class="fas fa-bell ms-1"></i></span>
                            {% elif pedido.estado_pedido == 'ENTREGADO' %}
                                <span class="badge bg-success border border-success">Entregado <i class="fas fa-check ms-1"></i></span>
                            {% elif pedido.estado_pedido == 'CANCELADO' %}
                                <span class="badge bg-danger border border-danger">Cancelado</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ pedido.estado_pedido }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- CUERPO DEL TICKET -->
                    <div class="card-body p-4">
                        <h6 class="text-muted text-uppercase small mb-4" style="letter-spacing: 2px; border-bottom: 1px solid #333; padding-bottom: 10px;">
                            Detalle del consumo
                        </h6>

                        <!-- LISTA DE PRODUCTOS (Aquí estaba el error, corregido a .detalles.all) -->
                        <ul class="list-unstyled mb-4">
                            {% for detalle in pedido.detalles.all %}
                            <li class="d-flex justify-content-between align-items-center mb-3">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-dark border border-secondary me-3 rounded-pill" style="min-width: 30px;">{{ detalle.cantidad }}</span>
                                    <span class="text-white fs-5" style="font-family: 'Playfair Display', serif;">
                                        {{ detalle.producto.nombre_producto }}
                                    </span>
                                </div>
                                <div class="text-end">
                                    <span class="title-gold fw-bold">{{ detalle.subtotal }} Bs.</span>
                                </div>
                            </li>
                            {% empty %}
                            <li class="text-center text-danger">Error: No se encontraron detalles para este pedido.</li>
                            {% endfor %}
                        </ul>

                        <!-- TOTAL -->
                        <div class="d-flex justify-content-between align-items-center pt-3 border-top border-secondary" style="border-top-style: dashed !important;">
                            <span class="text-muted text-uppercase small">Total Pagado</span>
                            <span class="title-gold display-6 fw-bold" style="font-family: 'Playfair Display', serif;">
                                {{ pedido.total }} Bs.
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}

            {% else %}
                <!-- ESTADO VACÍO -->
                <div class="text-center py-5">
                    <i class="fas fa-utensils fa-4x text-muted mb-3 opacity-25"></i>
                    <h3 class="text-white" style="font-family: 'Playfair Display', serif;">Aún no has ordenado nada</h3>
                    <a href="{% url 'menu_page' %}" class="btn btn-outline-warning mt-3 rounded-pill px-4 text-uppercase">Ver Menú</a>
                </div>
            {% endif %}

        </div>
    </div>
</div>
{% endblock %}