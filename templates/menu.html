{% extends 'base.html' %}
{% load static %}
{% block title %}Nuestro Menú{% endblock %}

{% block extra_css %}
<style>
    /* =========================================
       1. GRID DE PRODUCTOS (Responsive)
       ========================================= */
    .menu-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        padding-bottom: 80px;
    }

    @media (max-width: 576px) {
        .menu-grid {
            grid-template-columns: repeat(2, 1fr); /* 2 columnas en móvil */
            gap: 10px;
        }
        .card-producto .card-body { padding: 0.8rem !important; }
        .card-producto h5 { font-size: 1rem !important; margin-bottom: 0.3rem; }
        .card-producto .precio { font-size: 1.1rem !important; }
        .card-producto .btn-add { font-size: 0.8rem !important; padding: 0.4rem 0.8rem; }
        .card-img-top { height: 140px !important; }
    }

    /* =========================================
       2. TARJETAS DE PRODUCTO
       ========================================= */
    .card-producto {
        background-color: rgba(30, 25, 25, 0.95);
        border: 1px solid #4d3a36;
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.2s;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .card-producto:hover {
        transform: translateY(-3px);
        border-color: #c09a5b;
    }
    
    .card-img-top {
        height: 200px;
        object-fit: cover;
        width: 100%;
    }

    .title-gold { color: #c09a5b; font-family: 'Playfair Display', serif; }
    
    /* =========================================
       3. BOTONES DE CATEGORÍA (Estilo Nube/Tags)
       ========================================= */
    .nav-pills {
        justify-content: center;
        gap: 10px;
    }
    
    .nav-pills .nav-link {
        color: #d1d5db;
        background-color: rgba(255,255,255,0.05);
        border: 1px solid #444;
        border-radius: 50px;
        padding: 10px 20px;
        margin: 0;
        white-space: nowrap;
        transition: all 0.3s ease;
    }
    
    .nav-pills .nav-link:hover {
        background-color: rgba(255,255,255,0.1);
        border-color: #c09a5b;
    }

    .nav-pills .nav-link.active {
        background-color: #c09a5b;
        color: #fff;
        border-color: #c09a5b;
        box-shadow: 0 4px 10px rgba(192, 154, 91, 0.3);
    }

    /* =========================================
       4. BOTÓN FLOTANTE DEL CARRITO
       ========================================= */
    .floating-cart-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
        border-radius: 50px;
        padding: 12px 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        background-color: #c09a5b;
        border: none;
        color: #fff;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
    }
    .floating-cart-btn:hover {
        background-color: #a07d4b;
        transform: scale(1.05);
        color: #fff;
    }
    .cart-badge {
        background-color: #dc3545;
        color: white;
        border-radius: 50%;
        padding: 2px 8px;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<main id="main-content" class="container my-4">

    <h1 class="text-center title-gold display-5 mb-4">Nuestro Menú</h1>

    <!-- FILTROS (Categorías) -->
    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist" style="display: flex; flex-wrap: wrap;">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-all-tab" data-bs-toggle="pill" data-bs-target="#pills-all" type="button">Todo</button>
        </li>
        {% for key, value in categorias_choices.items %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-{{ key }}-tab" data-bs-toggle="pill" data-bs-target="#pills-{{ key }}" type="button">{{ value }}</button>
        </li>
        {% endfor %}
    </ul>

    <!-- CONTENIDO DE LAS PESTAÑAS -->
    <div class="tab-content" id="pills-tabContent">
        
        <!-- Pestaña Todo -->
        <div class="tab-pane fade show active" id="pills-all" role="tabpanel">
            <div class="menu-grid">
                {% for categoria, lista_productos in productos_agrupados.items %}
                    {% for producto in lista_productos %}
                        {% include 'pedidos/includes/producto_card.html' with producto=producto %}
                    {% endfor %}
                {% endfor %}
            </div>
        </div>

        <!-- Pestañas Individuales -->
        {% for key, label in categorias_choices.items %}
        <div class="tab-pane fade" id="pills-{{ key }}" role="tabpanel">
            <div class="menu-grid">
                {% for categoria, lista_productos in productos_agrupados.items %}
                    {% if categoria == key %}
                        {% for producto in lista_productos %}
                            {% include 'pedidos/includes/producto_card.html' with producto=producto %}
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}

    </div>

</main>

<!-- BOTÓN FLOTANTE CARRITO -->
<button class="floating-cart-btn" id="btn-carrito-flotante" type="button" data-bs-toggle="modal" data-bs-target="#cartModal" style="{% if cantidad_total == 0 %}display: none;{% endif %}">
    <i class="fas fa-shopping-cart fa-lg"></i>
    <span class="d-none d-md-inline">Ver Pedido</span>
    <span class="cart-badge" id="cart-count-badge">{{ cantidad_total }}</span>
</button>

<!-- MODAL CARRITO -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content card-dark-theme" style="background-color: #1f1f1f; color: #fff;">
            <div class="modal-header border-secondary">
                <h5 class="modal-title title-gold">Tu Pedido</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="cart-modal-body">
                {% include 'pedidos/includes/cart_body.html' %}
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Seguir pidiendo</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // ==========================================
    // 1. FUNCIÓN: AGREGAR AL CARRITO
    // ==========================================
    function agregarAlCarrito(productoId, nombreProducto) {
        const btn = document.getElementById(`btn-add-${productoId}`);
        const originalContent = btn.innerHTML;
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        fetch(`/pedidos/agregar/${productoId}/`, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                actualizarInterfazCarrito(data);
                
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.classList.remove('btn-outline-light');
                btn.classList.add('btn-success');
                
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-light');
                }, 1500);
            }
        })
        .catch(error => window.location.href = `/pedidos/agregar/${productoId}/`);
    }

    // ==========================================
    // 2. FUNCIÓN: ELIMINAR DEL CARRITO
    // ==========================================
    function eliminarDelCarrito(productoId) {
        fetch(`/pedidos/eliminar/${productoId}/`, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                actualizarInterfazCarrito(data);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // ==========================================
    // 3. ACTUALIZAR INTERFAZ (Helper)
    // ==========================================
    function actualizarInterfazCarrito(data) {
        const badge = document.getElementById('cart-count-badge');
        const btnFlotante = document.getElementById('btn-carrito-flotante');
        const modalBody = document.getElementById('cart-modal-body');

        // Actualizar número rojo
        if (badge) badge.innerText = data.cart_count;
        
        // Mostrar/Ocultar botón flotante
        if (btnFlotante) {
            btnFlotante.style.display = (data.cart_count > 0) ? 'flex' : 'none';
        }

        // Actualizar contenido del modal
        if (modalBody) {
            modalBody.innerHTML = data.cart_html;
        }
    }

    // ==========================================
    // 4. LÓGICA DE NAVEGACIÓN (Pestañas)
    // ==========================================
    function activarPestanaDesdeHash() {
        const hash = window.location.hash.replace('#', '');
        if (hash) {
            const tabButton = document.getElementById(`pills-${hash}-tab`);
            if (tabButton) {
                const tab = new bootstrap.Tab(tabButton);
                tab.show();
                setTimeout(() => {
                    tabButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }
    }

    window.addEventListener('load', activarPestanaDesdeHash);
    window.addEventListener('hashchange', activarPestanaDesdeHash);

    document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(btn => {
        btn.addEventListener('shown.bs.tab', function (e) {
            const id = e.target.id.replace('pills-', '').replace('-tab', '');
            if(id !== 'all') {
                history.replaceState(null, null, `#${id}`);
            } else {
                history.replaceState(null, null, ' ');
            }
        });
    });
</script>
{% endblock %}