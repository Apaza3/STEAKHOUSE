{% extends 'base.html' %}
{% load static %}

{% block title %}Hacer Reserva{% endblock %}

{% block content %}
<main id="main-content" class="container my-5">
    
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <div class="card card-dark-theme shadow-lg">
                <div class="card-body p-4 p-md-5">

                    <h1 class="text-center title-gold display-5 mb-4">Haz tu Reserva</h1>
                    <p class="text-center fs-5 mb-4">
                        Asegura tu lugar en nuestra mesa. Rellena el formulario para completar tu reserva.
                    </p>

                    <form method="POST" action="{% url 'reservas_page' %}" id="reservationForm">
                        {% csrf_token %}
                        
                        <div class="row g-4">
                            <div class="col-lg-6">
                                <h3 class="title-gold fs-4 mb-3">Detalles</h3>
                                <div class="mb-3">
                                    <label for="{{ form.fecha_reserva.id_for_label }}" class="form-label">Fecha de Reserva</label>
                                    {{ form.fecha_reserva }}
                                </div>
                                <div class="mb-3">
                                    <label for="{{ form.hora_reserva.id_for_label }}" class="form-label">Hora de Reserva</label>
                                    {{ form.hora_reserva }}
                                </div>
                                <div class="mb-3">
                                    <label for="{{ form.numero_personas.id_for_label }}" class="form-label">Número de Personas</label>
                                    {{ form.numero_personas }}
                                </div>
                                <div class="mb-3">
                                    <label for="{{ form.mesa.id_for_label }}" class="form-label">Mesa (Opcional)</label>
                                    {{ form.mesa }}
                                    <div class="form-text">Solo se muestran mesas disponibles.</div>
                                </div>
                            </div>

                            <div class="col-lg-6">
                                <h3 class="title-gold fs-4 mb-3">Tus Datos y Pago</h3>
                                
                                <div class="mb-3">
                                    <label for="{{ form.cliente.id_for_label }}" class="form-label">Cliente</label>
                                    {{ form.cliente }}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.tipo_pago.id_for_label }}" class="form-label">Tipo de Reserva</label>
                                    {{ form.tipo_pago }}
                                </div>

                                <div id="payment-policy-qr" class="alert alert-warning mt-4" style="display: none; border-color: #c89b3f;">
                                    <h5 class="alert-heading title-gold">Política de Pago QR</h5>
                                    <p>Se te redirigirá a una pantalla para simular un pago QR. Tu reserva quedará 'PENDIENTE' hasta confirmar el pago.</p>
                                </div>
                                
                                <div id="payment-policy-tarjeta" class="alert alert-info mt-4" style="display: none; border-color: #c89b3f;">
                                    <h5 class="alert-heading title-gold">Política de Pago con Tarjeta</h5>
                                    <p>Se te redirigirá a un formulario de pago seguro para ingresar los datos de tu tarjeta.</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 mt-4 pt-3" style="border-top: 1px solid #c89b3f;">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="id_politicas" required>
                                <label class="form-check-label" for="id_politicas">
                                    He leído y acepto las <a href="#">políticas de reserva</a>. (Requerido)
                                </label>
                            </div>
                            
                            <div class="form-check mt-3" id="checkbox-no-show" style="display: none;">
                                <input class="form-check-input" type="checkbox" id="id_politicas_no_show">
                                <label class="form-check-label" for="id_politicas_no_show">
                                    Entiendo la <a href="#">política de "No Show"</a> y acepto el cargo por pago adelantado. (Requerido al pagar)
                                </label>
                            </div>
                        </div>
                        <div class="text-center mt-5">
                            <button type="submit" class="btn btn-outline-light btn-lg" style="border-color: #c89b3f; color: #f4f0e8; min-width: 250px;">
                                Continuar
                            </button>
                        </div>

                    </form>
                </div>
            </div>

        </div>
    </div>

</main>
{% endblock %}


{% block extra_js %}
<script>
    function togglePago() {
        var tipoPagoSelect = document.getElementById('id_tipo_pago');
        
        if (tipoPagoSelect) {
            var tipoPago = tipoPagoSelect.value;
            
            // Elementos que vamos a mostrar/ocultar
            var policyQR = document.getElementById('payment-policy-qr');
            var policyTarjeta = document.getElementById('payment-policy-tarjeta');
            var checkboxNoShowDiv = document.getElementById('checkbox-no-show');
            var checkboxNoShowInput = document.getElementById('id_politicas_no_show');

            // 1. Ocultar todo primero y resetear 'required'
            policyQR.style.display = 'none';
            policyTarjeta.style.display = 'none';
            checkboxNoShowDiv.style.display = 'none';
            checkboxNoShowInput.required = false;

            // 2. Mostrar el relevante
            if (tipoPago === 'PAGO_ADELANTADO') {
                policyQR.style.display = 'block';
                checkboxNoShowDiv.style.display = 'block';
                checkboxNoShowInput.required = true; // Hacerlo requerido
            
            } else if (tipoPago === 'TARJETA') {
                policyTarjeta.style.display = 'block';
                checkboxNoShowDiv.style.display = 'block';
                checkboxNoShowInput.required = true; // Hacerlo requerido
            
            } else if (tipoPago === 'SOLO_MESA') {
                // No hace falta mostrar nada extra
            }
        }
    }
    
    document.addEventListener("DOMContentLoaded", function() {
        var tipoPagoSelect = document.getElementById('id_tipo_pago');
        if (tipoPagoSelect) {
            tipoPagoSelect.addEventListener('change', togglePago);
        }
        // Ejecutar una vez al cargar la página
        togglePago();
    });
</script>
{% endblock %}