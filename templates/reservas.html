{% extends 'base.html' %}
{% load static %}

{% block title %}Reservar Mesa{% endblock %}

<!-- IMPORTANTE: Asegura que el body tenga la clase para el fondo correcto -->
{% block body_class %}body-reservas{% endblock %}

{% block extra_css %}
<style>
    /* Mantenemos tus estilos de modales y enlaces */
    .link-gold {
        color: #c09a5b;
        text-decoration: underline;
        cursor: pointer;
        border: none;
        background: none;
        padding: 0;
        font-size: inherit;
    }
    .link-gold:hover { color: #fff; }
    
    .form-logo {
        max-width: 120px;
        height: auto;
        filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
    }
    
    /* Ajuste para que el contenedor de mesas use el Grid de Bootstrap correctamente */
    #contenedor-mesas {
        min-height: 100px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container reserva-flow-container">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10 col-sm-12">
            
            <!-- LOGO CENTRALIZADO (Tu ruta original) -->
            <div class="text-center mb-4">
                <img src="{% static 'core/img/logo-steakhouse.png' %}" alt="The Steakhouse" class="form-logo img-fluid">
                <h2 class="text-white font-serif-display mt-2" style="text-shadow: 2px 2px 4px #000;">Haz tu Reserva</h2>
            </div>

            <form method="POST" id="formReserva">
                {% csrf_token %}
                {{ form.cliente }}
                <!-- El input de mesa_id se genera automáticamente con los radios, no necesitamos el hidden manual si el nombre coincide -->

                <!-- SECCIÓN 1: FECHA Y HORA -->
                <div class="card card-dark-theme mb-4">
                    <div class="card-body">
                        <h4 class="step-title">1. ¿Cuándo nos visitas?</h4>
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label small text-uppercase text-muted">Fecha</label>
                                {{ form.fecha_reserva }}
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-uppercase text-muted">Hora</label>
                                {{ form.hora_reserva }}
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-uppercase text-muted">Personas</label>
                                {{ form.numero_personas }}
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-uppercase text-muted">Duración</label>
                                {{ form.duracion_horas }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 2: SELECCIÓN VISUAL DE MESA (DISEÑO PREMIUM) -->
                <div class="card card-dark-theme mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4 class="step-title mb-0">2. Elige tu Mesa</h4>
                            <div id="loadingMesas" class="spinner-border text-warning spinner-sm" role="status" style="display:none;"></div>
                        </div>
                        
                        <p class="small text-muted"><i class="fas fa-mouse-pointer me-1"></i> Toca una mesa disponible para seleccionarla.</p>
                        
                        <!-- AQUÍ SE GENERAN LAS MESAS VISUALMENTE -->
                        <!-- Usamos row de bootstrap para el grid responsive -->
                        <div id="contenedor-mesas" class="row g-3 justify-content-center">
                            <div class="text-center w-100 text-muted py-3">Cargando mapa de mesas...</div>
                        </div>

                        <!-- Feedback de selección -->
                        <div id="mesa-seleccionada-info" class="alert alert-success mt-3 d-flex align-items-center" style="display:none; background: rgba(40,167,69,0.2); border: 1px solid #28a745; color: #fff;">
                            <i class="fas fa-check-circle fs-4 me-3"></i>
                            <div>
                                <strong>¡Mesa Seleccionada!</strong><br>
                                <span id="txt-mesa-sel" class="small">...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 3: PAGO Y POLÍTICAS -->
                <div class="card card-dark-theme mb-4">
                    <div class="card-body">
                        <h4 class="step-title">3. Confirmación</h4>
                        
                        <div class="mb-4">
                            <label class="form-label small text-uppercase text-muted">Método de Pago</label>
                            {{ form.tipo_pago }}
                        </div>

                        <!-- Mensaje de Pago (Oculto por defecto) -->
                        <div id="info-pago-box" class="alert alert-warning small" style="display:none; background: rgba(255,193,7,0.1); border: 1px solid #ffc107; color: #ffeeba;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Para confirmar con este método, se requiere un <strong>adelanto de 30 Bs</strong>.
                        </div>

                        <!-- Política 1: Reserva (Siempre visible) -->
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" required id="check_politica_reserva">
                            <label class="form-check-label small text-light" for="check_politica_reserva">
                                He leído y acepto las <button type="button" class="link-gold" data-bs-toggle="modal" data-bs-target="#modalPoliticaReserva">Políticas de Reserva</button>.
                            </label>
                        </div>

                        <!-- Política 2: No Show (Solo visible si hay pago) -->
                        <div class="form-check mt-2" id="box-policy-noshow" style="display: none;">
                            <input class="form-check-input" type="checkbox" id="check_politica_noshow">
                            <label class="form-check-label small text-light" for="check_politica_noshow">
                                Entiendo y acepto la <button type="button" class="link-gold" data-bs-toggle="modal" data-bs-target="#modalPoliticaNoShow">Política de "No Show"</button>.
                            </label>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mt-4 py-3 fw-bold text-uppercase" style="background-color: #c09a5b; border: none; letter-spacing: 1px;">
                            Confirmar Reserva
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- PARTICULAS DE FUEGO (FONDO) -->
<div class="fire-particles-container">
    <div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div>
    <div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div>
    <div class="particle"></div><div class="particle"></div><div class="particle"></div><div class="particle"></div>
</div>

<!-- MODALES DE POLÍTICAS -->
<div class="modal fade" id="modalPoliticaReserva" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-bottom border-secondary">
        <h5 class="modal-title text-warning">Políticas de Reserva</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body small">
        <ul class="ps-3 mb-0">
            <li class="mb-2">Tu mesa se guardará por un máximo de <strong>15 minutos</strong> tras la hora reservada.</li>
            <li class="mb-2">Puedes modificar tu reserva hasta 2 horas antes sin penalización.</li>
            <li>Nos reservamos el derecho de asignar una mesa equivalente si la seleccionada no está disponible por fuerza mayor.</li>
        </ul>
      </div>
      <div class="modal-footer border-top border-secondary p-1">
        <button type="button" class="btn btn-sm btn-secondary w-100" data-bs-dismiss="modal">Entendido</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalPoliticaNoShow" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-bottom border-secondary">
        <h5 class="modal-title text-danger">Política de "No Show"</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body small">
        <p><strong>¿Qué significa "No Show"?</strong></p>
        <p>Es cuando el cliente no se presenta a su reserva confirmada sin haber cancelado previamente.</p>
        <hr class="border-secondary">
        <p class="mb-1 text-warning">Al realizar el pago adelantado, aceptas que:</p>
        <ul class="ps-3 mb-0">
            <li>Si no asistes, el adelanto de <strong>30 Bs NO será reembolsado</strong>.</li>
            <li>Este monto cubre la reserva exclusiva del espacio y la pérdida de oportunidad.</li>
        </ul>
      </div>
      <div class="modal-footer border-top border-secondary p-1">
        <button type="button" class="btn btn-sm btn-secondary w-100" data-bs-dismiss="modal">Acepto las condiciones</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // --- Referencias DOM ---
    const dateInput = document.getElementById('{{ form.fecha_reserva.auto_id }}');
    const timeInput = document.getElementById('{{ form.hora_reserva.auto_id }}');
    const durationInput = document.getElementById('{{ form.duracion_horas.auto_id }}');
    const peopleInput = document.getElementById('{{ form.numero_personas.auto_id }}');
    
    const containerMesas = document.getElementById('contenedor-mesas');
    const loading = document.getElementById('loadingMesas');
    const txtMesaSel = document.getElementById('txt-mesa-sel');
    const infoDiv = document.getElementById('mesa-seleccionada-info');
    
    const pagoSelect = document.getElementById('{{ form.tipo_pago.auto_id }}');
    const infoPagoBox = document.getElementById('info-pago-box');
    const boxPolicyNoShow = document.getElementById('box-policy-noshow');
    const checkNoShow = document.getElementById('check_politica_noshow');

    // --- 1. Lógica de Carga de Mesas (AJAX) ---
    window.cargarMesas = function() {
        const fecha = dateInput.value;
        const hora = timeInput.value;
        const duracion = durationInput.value;
        const personas = parseInt(peopleInput.value) || 1;

        if(!fecha || !hora) return;

        loading.style.display = 'block';
        containerMesas.style.opacity = '0.5';

        // Llamada a tu API existente
        fetch(`/reservas/api/check-mesas/?fecha=${fecha}&hora=${hora}&duracion=${duracion}`)
            .then(response => response.json())
            .then(data => {
                containerMesas.innerHTML = ''; 
                
                if(data.mesas && data.mesas.length > 0) {
                    data.mesas.forEach(mesa => {
                        // Lógica Visual Premium/Normal (Compatible con tu JSON)
                        let isPremium = (mesa.tipo && (mesa.tipo.includes('Premium') || mesa.tipo.includes('PREMIUM')));
                        let tipoClass = isPremium ? 'premium' : 'normal';
                        let badgeHtml = isPremium ? '<span class="badge rounded-pill mesa-badge">PREMIUM</span>' : '';
                        
                        // Lógica de Estado
                        let esAdecuada = mesa.capacidad >= personas;
                        let estaLibre = mesa.estado === 'LIBRE';
                        let esSeleccionable = estaLibre && esAdecuada;
                        
                        // Texto de Estado
                        let textoEstado = '';
                        if(!estaLibre) textoEstado = '<div class="text-danger small fw-bold mt-2">Ocupada</div>';
                        else if(!esAdecuada) textoEstado = '<div class="text-warning small mt-2">Muy pequeña</div>';
                        else textoEstado = '<div class="text-success small fw-bold mt-2">Disponible</div>';

                        let iconClass = isPremium ? 'fa-crown' : 'fa-chair';

                        // Generamos el HTML con las nuevas clases de main.css
                        let html = `
                        <div class="col-6 col-md-4 col-lg-3 mesa-selector-container">
                            <label class="mesa-card-label w-100 ${tipoClass}">
                                <input type="radio" name="mesa_id" value="${mesa.id}" class="mesa-card-input" 
                                    onchange="actualizarInfoMesa('${mesa.numero}')" 
                                    required 
                                    ${!esSeleccionable ? 'disabled' : ''}>
                                
                                <div class="mesa-content" style="${!esSeleccionable ? 'opacity:0.5; cursor:not-allowed;' : ''}">
                                    <i class="fas ${iconClass} icon-mesa"></i>
                                    <h5 class="fw-bold mb-1">Mesa ${mesa.numero}</h5>
                                    <small class="d-block mb-2">${mesa.capacidad} Personas</small>
                                    ${badgeHtml}
                                    ${textoEstado}
                                </div>
                            </label>
                        </div>
                        `;
                        containerMesas.insertAdjacentHTML('beforeend', html);
                    });
                } else {
                    containerMesas.innerHTML = '<div class="col-12 text-center text-muted py-4"><i class="fas fa-calendar-times fa-2x mb-2"></i><p>No hay mesas disponibles para los criterios seleccionados.</p></div>';
                }
                loading.style.display = 'none';
                containerMesas.style.opacity = '1';
                infoDiv.style.display = 'none';
            })
            .catch(error => {
                console.error(error);
                loading.style.display = 'none';
            });
    };

    // --- 2. Actualizar Info al Seleccionar ---
    window.actualizarInfoMesa = function(numero) {
        txtMesaSel.innerText = `Mesa Número ${numero}`;
        infoDiv.style.display = 'flex';
    };

    // Listeners
    dateInput.addEventListener('change', cargarMesas);
    timeInput.addEventListener('change', cargarMesas);
    durationInput.addEventListener('change', cargarMesas);
    peopleInput.addEventListener('change', cargarMesas);

    // --- 3. Lógica de Políticas ---
    function actualizarPoliticas() {
        const metodo = pagoSelect.value;
        if(metodo === 'PAGO_ADELANTADO' || metodo === 'TARJETA') {
            infoPagoBox.style.display = 'block';
            boxPolicyNoShow.style.display = 'block';
            checkNoShow.required = true; 
        } else {
            infoPagoBox.style.display = 'none';
            boxPolicyNoShow.style.display = 'none';
            checkNoShow.required = false;
            checkNoShow.checked = false;
        }
    }

    pagoSelect.addEventListener('change', actualizarPoliticas);

    // Inicializar
    if(dateInput.value && timeInput.value) {
        cargarMesas();
    }
    actualizarPoliticas();
});
</script>
{% endblock %}